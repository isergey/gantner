Функция ПолучитьОбъектЗапроса(XMLСтрокаЗапроса) Экспорт
        попытка
                ЧтениеXML = Новый ЧтениеXML;
                ЧтениеXML.УстановитьСтроку(XMLСтрокаЗапроса);
               
                ПостроительDOM = Новый ПостроительDOM;
                ДокументДом = ПостроительDOM.Прочитать(ЧтениеXML);
                РазыменовательПИ = Новый РазыменовательПространствИменDOM(ДокументДом);
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/@type", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
               
                СтроковоеЗначение = Результат.СтроковоеЗначение;
                Если (СтроковоеЗначение <> "card_ident") Тогда
                        ВызватьИсключение  "Ошибка. Ожидался тип запроса card_ident. Текущий: [" + СтроковоеЗначение + "].";
                КонецЕсли;
               
                ОбъектЗапроса = Новый Структура; // ТипЗапроса - строка, Терминал - объект описания терминала
               
                ОбъектЗапроса.Вставить("ТипЗапроса", СтроковоеЗначение);
               
               
                Терминал = Новый Структура; // "Идентификатор" - строка, "Адрес" - строка, "Порт" - целое, "СтанцияОбслуживания" - целое (0 или 1)     
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/terminal/@id", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение = "") Тогда
                        ВызватьИсключение  "Ошибка. Пустрой идентификатор терминала.";
                КонецЕсли;
               
                Терминал.Вставить("Идентификатор", Значение);
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/terminal/@addr", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение = "") Тогда
                        ВызватьИсключение "Ошибка. Пустрой адрес терминала.";
                КонецЕсли;
               
                Терминал.Вставить("Адрес", Значение);
               
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/terminal/@port", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение = "") Тогда
                        ВызватьИсключение "Ошибка. Пустрой порт терминала.";
                КонецЕсли;
               
                Терминал.Вставить("Порт", Цел(Значение));
               
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/terminal/@enrollment", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение <> "0") и (Значение <> "1")  Тогда
                        ВызватьИсключение "Ошибка. Признак станции обслуживания у терминала должен быть 0 или 1. Возможно он не указан.";
                КонецЕсли;
               
                Терминал.Вставить("СтанцияОбслуживания", Значение);
               
                ОбъектЗапроса.Вставить("Терминал", Терминал);
               
                Карта = Новый Структура;
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/card/@id", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение = "")  Тогда
                        ВызватьИсключение "Ошибка. Не указан идентификатор карты.";
                КонецЕсли;
               
                Карта.Вставить("Идентификатор", Значение);
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/card/@int_id", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение = "")  Тогда
                        ВызватьИсключение "Ошибка. Не указан int идентификатор карты.";
                КонецЕсли;
               
                Карта.Вставить("intИдентификатор", Значение);
               
                Результат = ДокументДом.ВычислитьВыражениеXPath("/request/card/@type", ДокументДом, РазыменовательПИ, ТипРезультатаDOMXPath.Строка);
                Значение = Результат.СтроковоеЗначение;
                Если (Значение = "")  Тогда
                        ВызватьИсключение "Ошибка. Не указан тип карты.";
                КонецЕсли;
               
                Карта.Вставить("Тип", Значение);
               
                ОбъектЗапроса.Вставить("Карта", Карта);
               
                Возврат ОбъектЗапроса;     
        исключение
                ВызватьИсключение ОписаниеОшибки();
        конецпопытки;      
КонецФункции
